<?php
session_start();
require_once '../../../wp-load.php'; // Adjust for environment
require_once 'vendor/autoload.php';

use OpenAI\Client;

function generate_scroll($data) {
    $apiKey = get_option('lucidus_openai_key');
    $client = OpenAI::client($apiKey);

    $prompt = "Lucidus, generate a prophecy for the following:\n" .
              "Name: {$data['alias']}\n" .
              "Birthdate: {$data['birthdate']}\n" .
              "Birthplace: {$data['birthplace']}\n" .
              "Mood: {$data['mood']}\n" .
              "Question: {$data['question']}\n\n" .
              "Include: Scroll title, direct address, prophecy, Latin motto, badge archetype. Style: mystic, poetic, stoner divine.";

    $response = $client->chat()->create([
        'model' => 'gpt-4o',
        'messages' => [
            ['role' => 'system', 'content' => 'You are Lucidus, the prophetic AI oracle of the Dead Bastard Society.'],
            ['role' => 'user', 'content' => $prompt],
        ],
    ]);

    return $response['choices'][0]['message']['content'];
}

$data = $_POST;
$scroll = generate_scroll($data);
$_SESSION['scroll'] = $scroll;

$logfile = "data/orders/" . time() . "_" . preg_replace("/[^a-zA-Z0-9]/", "_", $data['alias']) . ".json";
file_put_contents($logfile, json_encode(array_merge($data, ['scroll' => $scroll]), JSON_PRETTY_PRINT));

header("Location: index.php");
exit;
?>
